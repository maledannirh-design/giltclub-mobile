<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GILT Club Mobile</title>

<!-- ================= DESKTOP REDIRECT ================= -->
<script>
(function(){

  var host = location.hostname;

  // deteksi device
  var isMobile = /android|iphone|ipad|ipod|blackberry|windows phone/i
      .test(navigator.userAgent.toLowerCase());

  // kalau dibuka pakai laptop → balik ke utama
  if(host === "m.giltclub.my.id"){
      if(!isMobile){
          location.replace("https://giltclub.my.id");
          return;
      }
  }

})();
</script>
<!-- =================================================== -->

<style>
body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:#0f172a;
  color:white;
  min-height:100vh;
  overflow-y:auto;
}

.card{
  width:90%;
  max-width:360px;
  margin:80px auto;
  display:none;
}



input{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
}

button{
  width:100%;
  padding:14px;
  margin-top:18px;
  border-radius:12px;
  border:none;
  background:#22c55e;
  color:white;
  font-size:18px;
  font-weight:bold;
  cursor:pointer;
}
#dashboard,
#guestPage{
  display:none;
  position:fixed;
  inset:0;
  overflow-y:auto;
  background:#0f172a;
  z-index:5;
}

</style>
</head>

<body>
<!-- LOGIN -->
<div class="card">
  <h2>GILT CLUB</h2>

  <input id="username" placeholder="Username">
  <input id="pin" type="password" placeholder="PIN">

  <button onclick="login()">LOGIN MEMBER</button>

  <button onclick="openGuest()" style="background:#f59e0b">
    MAIN SEBAGAI TAMU
  </button>
</div>


<!-- DASHBOARD -->
<div id="dashboard" style="display:none; padding:20px;">

  <h2 id="welcome"></h2>

  <!-- SALDO -->
  <div style="
    background:#1e293b;
    padding:18px;
    border-radius:14px;
    margin-top:20px;
  ">
    <div style="font-size:14px;opacity:.7">Saldo Wallet</div>
    <div id="balance" style="font-size:28px;font-weight:bold;margin-top:8px">
      Rp 0
    </div>
  </div>
<div style="margin-top:25px">
<div id="todayClass" style="
  margin-top:18px;
  background:#1e293b;
  padding:16px;
  border-radius:14px;
">
  <div style="opacity:.7;font-size:13px">Kelas Saya 2 Minggu Kedepan</div>
  <div id="todayContent" style="margin-top:8px">
    Tidak ada kelas, ayo reserve kak !
  </div>
</div>

  <button onclick="openBooking()" style="
    width:100%;
    background:#22c55e;
    padding:14px;
    border-radius:12px;
    border:none;
    color:white;
    font-weight:bold;
  ">
    BOOKING KELAS
  </button>

  <div id="bookingPanel" style="
    display:none;
    margin-top:15px;
    background:#020617;
    padding:12px;
    border-radius:14px;
  ">
    <div id="scheduleList"></div>
  </div>

</div>

  
  <!-- TOPUP -->
  <div style="margin-top:25px">
    <input id="topupAmount" type="number"
           placeholder="Nominal Top Up (contoh: 50000)"
           style="width:100%;padding:14px;border-radius:10px;border:none;margin-bottom:12px;">

    <button onclick="requestTopup()" style="background:#3b82f6">
      TOP UP SALDO
    </button>
  </div>

  <!-- HISTORY -->
  <div style="margin-top:30px">

  <button onclick="toggleHistory()" style="
    width:100%;
    background:#334155;
    padding:14px;
    border-radius:12px;
    border:none;
    color:white;
    font-weight:bold;
  ">
    LIHAT RIWAYAT TRANSAKSI
  </button>

  <div id="historyPanel" style="
    display:none;
    margin-top:15px;
    background:#020617;
    padding:12px;
    border-radius:14px;
    max-height:320px;
    overflow-y:auto;
  ">
    <div id="historyList"></div>
  </div>

</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" style="display:none;margin-top:35px">

  <h3>Admin Panel</h3>

  <!-- TOPUP SECTION -->
  <div style="margin-bottom:25px">

    <button onclick="loadPendingTopup()" 
      style="background:#f59e0b;margin-bottom:10px">
      CEK TOPUP MASUK
    </button>

    <div id="pendingList"></div>

  </div>

  <!-- GUEST PAYMENT SECTION -->
  <div>

    <button onclick="loadGuestProof()" 
      style="background:#06b6d4;margin-bottom:10px">
      CEK PEMBAYARAN TAMU
    </button>

    <div id="guestProofList"></div>

  </div>

</div>


  <!-- LOGOUT -->
  <button onclick="logout()" style="background:#ef4444;margin-top:30px;">
    LOGOUT
  </button>

</div>
<!-- GUEST PAGE -->
<div id="guestPage" style="display:none;padding:20px">

  <h2>Booking Tamu</h2>

  <input id="g_name" placeholder="Nama">
  <input id="g_phone" placeholder="No HP">
  <input id="g_email" placeholder="Email">

  <button onclick="loadGuestSchedule()" style="background:#22c55e">
    LIHAT JADWAL
  </button>

  <div id="guestSchedule" style="margin-top:20px"></div>

  <button onclick="backLogin()" style="background:#ef4444">
    KEMBALI
  </button>

</div>


<script>

const SERVER = "https://script.google.com/macros/s/AKfycbyO0YCZs1N5VgXLB5UNpNZCaMX-StL2JKcbaj2cDUHPmBS1RxX-Hhc0yqhJqs4mXNHP/exec";

async function login(){

  const username = document.getElementById("username").value;
  const pin = document.getElementById("pin").value;

  const formData = new URLSearchParams();
  formData.append("action","login");
  formData.append("username",username);
  formData.append("pin",pin);
  formData.append("device",navigator.userAgent);

  try{

    const res = await fetch(SERVER,{
      method:"POST",
      body:formData
    });

    const text = await res.text();
    const data = JSON.parse(text);

    if(data.status==="ok"){
        localStorage.setItem("guser",JSON.stringify(data.user));
        localStorage.setItem("gtoken",data.token);
        showDashboard(data.user);
    }else{
        alert(data.message);
    }

  }catch(err){
    alert("Tidak bisa konek ke server");
    console.log(err);
  }
}

// ===== AUTO LOGIN CHECK =====
document.addEventListener("DOMContentLoaded", checkSession);

async function checkSession(){

  const card = document.querySelector(".card");
  const token = localStorage.getItem("gtoken");

  // default: sembunyikan login dulu
  card.style.display = "none";

  // kalau tidak ada token → langsung tampilkan login
  if(!token){
    card.style.display = "block";
    return;
  }

  try{

    const formData = new URLSearchParams();
    formData.append("action","session");
    formData.append("token",token);

    const res = await fetch(SERVER,{
      method:"POST",
      body:formData
    });

    const data = await res.json();

    if(data.status==="ok"){
        // session valid → langsung dashboard
        showDashboard(data.user);
        return;
    }

    // token invalid
    localStorage.removeItem("gtoken");
    localStorage.removeItem("guser");
    card.style.display = "block";

  }catch(err){
    // server unreachable → tetap kasih login
    console.log("session restore fail");
    card.style.display = "block";
  }
}

async function showDashboard(user){

  document.querySelector(".card").style.display = "none";
  document.getElementById("dashboard").style.display = "block";

  document.getElementById("welcome").innerText =
    "Welcome " + user.name;

  loadTodayBooking();
  await loadBalance();
  await new Promise(r => setTimeout(r, 700));
  await loadTodayBooking();
  await loadBalance();

  if(user.role === "ADMIN"){
    document.getElementById("adminPanel").style.display="block";
  }
}



async function loadBalance(){

  const token = localStorage.getItem("gtoken");

  const formData = new URLSearchParams();
  formData.append("action","balance");
  formData.append("token",token);

  const res = await fetch(SERVER,{
    method:"POST",
    body:formData
  });

  const data = await res.json();

  if(data.status==="ok"){
    document.getElementById("balance").innerText =
      "Rp " + Number(data.balance).toLocaleString("id-ID");
  }
}
async function loadPendingTopup(){

  const token = localStorage.getItem("gtoken");

  const fd = new URLSearchParams();
  fd.append("action","admin_topup_list");
  fd.append("token",token);

  const res = await fetch(SERVER,{method:"POST",body:fd});
  const data = await res.json();

  const list=document.getElementById("pendingList");
  list.innerHTML="";

  if(!data.data || data.data.length===0){
    list.innerHTML="<p>Tidak ada topup pending</p>";
    return;
  }

  data.data.forEach(t=>{
    list.innerHTML += `
      <div style="
        background:#1e293b;
        padding:12px;
        border-radius:12px;
        margin-bottom:12px;
      ">
        <b>${t.member_id}</b><br>
        Rp ${Number(t.amount).toLocaleString("id-ID")}<br><br>

        <button onclick="approveTopup('${t.topup_id}')"
          style="background:#22c55e;width:100%">
          APPROVE
        </button>
      </div>
    `;
  });
}
async function approveTopup(id){

  if(!confirm("Approve topup ini?")) return;

  const token = localStorage.getItem("gtoken");

  const fd = new URLSearchParams();
  fd.append("action","admin_topup_approve");
  fd.append("token",token);
  fd.append("topup_id",id);

  const res = await fetch(SERVER,{method:"POST",body:fd});
  const data = await res.json();

  if(data.status==="ok"){
    alert("Topup berhasil diapprove");
    loadPendingTopup();
    loadBalance(); // refresh saldo admin (kalau admin juga member)
  }else{
    alert(data.message);
  }
}

async function requestTopup(){

  const amount = document.getElementById("topupAmount").value;
  if(!amount || amount <= 0){
    alert("Masukkan nominal topup");
    return;
  }

  const token = localStorage.getItem("gtoken");

  const formData = new URLSearchParams();
  formData.append("action","topup");
  formData.append("token",token);
  formData.append("amount",amount);
  formData.append("method","TRANSFER");

  const res = await fetch(SERVER,{
    method:"POST",
    body:formData
  });

  const data = await res.json();

  if(data.status==="ok"){
    alert("Permintaan topup dikirim. Tunggu admin approve.");
    document.getElementById("topupAmount").value="";
  }else{
    alert(data.message);
  }
}
async function loadHistory(){

  const token = localStorage.getItem("gtoken");

  const fd = new URLSearchParams();
  fd.append("action","history");
  fd.append("token",token);

  const res = await fetch(SERVER,{method:"POST",body:fd});
  const data = await res.json();

  const list=document.getElementById("historyList");
  list.innerHTML="";

  if(!data.data || data.data.length===0){
    list.innerHTML="<p>Belum ada transaksi</p>";
    return;
  }

  data.data.forEach(t=>{

    const plus = t.type === "CREDIT";
    const color = plus ? "#22c55e" : "#ef4444";
    const sign  = plus ? "+" : "-";

    list.innerHTML += `
      <div style="
        background:#1e293b;
        padding:12px;
        border-radius:12px;
        margin-bottom:10px;
      ">
        <div style="font-size:14px;opacity:.8">${t.desc || "Transaksi"}</div>
        <div style="font-size:18px;font-weight:bold;color:${color}">
          ${sign} Rp ${Number(t.amount).toLocaleString("id-ID")}
        </div>
        <div style="font-size:12px;opacity:.5">
          Saldo: Rp ${Number(t.balance).toLocaleString("id-ID")}
        </div>
      </div>
    `;
  });
}

  let historyLoaded = false;

async function toggleHistory(){

  const panel = document.getElementById("historyPanel");

  if(panel.style.display === "none"){
    panel.style.display = "block";

    // load hanya sekali (hemat server)
    if(!historyLoaded){
      await loadHistory();
      historyLoaded = true;
    }

  }else{
    panel.style.display = "none";
  }
}
async function openBooking(){

  const panel = document.getElementById("bookingPanel");

  if(panel.style.display==="none"){
    panel.style.display="block";
    await loadSchedule();
  }else{
    panel.style.display="none";
  }
}
async function loadSchedule(){

  const token = localStorage.getItem("gtoken");

  const fd=new URLSearchParams();
  fd.append("action","schedule");
  fd.append("token",token);

  const res=await fetch(SERVER,{method:"POST",body:fd});
  const data=await res.json();

  const list=document.getElementById("scheduleList");
  list.innerHTML="";

  data.data.forEach(s=>{

    const sisa = s.slot - s.used;

    list.innerHTML += `
      <div style="
        background:#1e293b;
        padding:12px;
        border-radius:12px;
        margin-bottom:10px;
      ">
        <b>${s.kelas}</b><br>
        ${s.date} ${s.start}<br>
        Sisa slot: ${sisa}<br>
        Rp ${Number(s.price).toLocaleString("id-ID")}<br><br>

        <button onclick="bookClass('${s.date}','${s.kelas}')"
          style="background:#22c55e;width:100%">
          BOOK
        </button>
      </div>
    `;
  });
}
let bookingLock=false;

async function bookClass(date,kelas){

  if(bookingLock) return;
  bookingLock=true;

  if(!confirm("Booking kelas ini?")){
    bookingLock=false;
    return;
  }

  const token = localStorage.getItem("gtoken");

  const fd=new URLSearchParams();
  fd.append("action","booking");
  fd.append("token",token);
  fd.append("date",date);
  fd.append("kelas",kelas);

  try{
    const res=await fetch(SERVER,{method:"POST",body:fd});
    const data=await res.json();

    if(data.status==="ok"){
      alert("Booking berhasil!");
      loadBalance();
      loadTodayBooking();
      historyLoaded=false;
      loadSchedule();
    }else{
      alert(data.message);
    }
  }finally{
    bookingLock=false;
  }
}

async function loadTodayBooking(){

  const token = localStorage.getItem("gtoken");

  const fd=new URLSearchParams();
  fd.append("action","my_bookings");
  fd.append("token",token);

  const res=await fetch(SERVER,{method:"POST",body:fd});
  const data=await res.json();

  const el=document.getElementById("todayContent");

  if(!data.data || data.data.length===0){
    el.innerHTML="Tidak ada kelas, ayo reserve kak! ";
    return;
  }

  let html="";

  data.data.forEach(b=>{
    html+=`
      <div style="margin-top:10px">
        <b>${b.kelas}</b><br>
${b.date}<br>
Jam ${b.start} - ${b.end}<br>
Court ${b.court}
        <button onclick="cancelMyBooking('${b.booking_id}')"
          style="margin-top:8px;background:#ef4444">
          Batalkan
        </button>
      </div>
    `;
  });

  el.innerHTML=html;
}
async function cancelMyBooking(id){

  if(!confirm("Batalkan booking?")) return;

  const token=localStorage.getItem("gtoken");

  const fd=new URLSearchParams();
  fd.append("action","cancel_booking");
  fd.append("token",token);
  fd.append("booking_id",id);

  const res=await fetch(SERVER,{method:"POST",body:fd});
  const data=await res.json();

  if(data.status==="ok"){
    alert("Booking dibatalkan");
    loadTodayBooking();
    loadBalance();
    loadHistory();
  }else{
    alert(data.message);
  }
}

function logout(){
  localStorage.removeItem("gtoken");
  localStorage.removeItem("guser");
  location.reload();
}

  document.querySelectorAll("button").forEach(btn=>{
  btn.type="button";
});
function openGuest(){

  // tutup semua halaman
  document.querySelector(".card").style.display="none";
  document.getElementById("dashboard").style.display="none";

  // buka guest screen
  const g=document.getElementById("guestPage");
  g.style.display="block";
  window.scrollTo(0,0);
}
function backLogin(){

  document.getElementById("guestPage").style.display="none";
  document.getElementById("dashboard").style.display="none";
  document.querySelector(".card").style.display="block";

  window.scrollTo(0,0);
}

async function loadGuestSchedule(){

  const fd=new URLSearchParams();
  fd.append("action","schedule_public");

  const res=await fetch(SERVER,{method:"POST",body:fd});
  const data=await res.json();

  const list=document.getElementById("guestSchedule");
  list.innerHTML="";

  data.data.forEach(s=>{

    const sisa = s.slot - s.used;

    list.innerHTML+=`
      <div style="
        background:#1e293b;
        padding:12px;
        border-radius:12px;
        margin-bottom:12px;
      ">
        <b>${s.kelas}</b><br>
        ${s.date} ${s.start}<br>
        Slot: ${sisa}<br><br>

        Guest : Rp ${Number(s.guest_price).toLocaleString("id-ID")}<br>
        Member : Rp ${Number(s.member_price).toLocaleString("id-ID")}<br><br>

        <button onclick="guestBook('${s.date}','${s.kelas}')">
          BOOK
        </button>
      </div>
    `;
  });
}
async function guestBook(date,kelas){

  const name=document.getElementById("g_name").value;
  const phone=document.getElementById("g_phone").value;
  const email=document.getElementById("g_email").value;

  if(!name||!phone||!email){
    alert("Lengkapi data dulu");
    return;
  }

  const fd=new URLSearchParams();
  fd.append("action","guest_hold");
  fd.append("name",name);
  fd.append("phone",phone);
  fd.append("email",email);
  fd.append("date",date);
  fd.append("kelas",kelas);

  const res=await fetch(SERVER,{method:"POST",body:fd});
  const data=await res.json();

  if(data.status==="ok"){
    showPayment(data.hold_id,data.price,data.expired_at);
  }else{
    alert(data.message);
  }
}
function showPayment(holdId,price,expired){

  const html = `
  <div style="
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.85);
    z-index:9999;
    padding:20px;
    overflow:auto;
  " id="paymentModal">

    <div style="
      background:#0f172a;
      border-radius:16px;
      padding:18px;
      max-width:420px;
      margin:auto;
    ">

      <h2 style="margin-top:0">Pembayaran Booking</h2>

      <div style="margin:12px 0">
        Total Bayar:
        <div style="font-size:26px;font-weight:bold">
          Rp ${Number(price).toLocaleString("id-ID")}
        </div>
      </div>

      <hr>

      <h3>DANA</h3>
      Transfer ke:
      <div style="font-size:18px;font-weight:bold">
        085179694879
      </div>
      a.n Yayang Lely Mualifah

      <hr>

      <h3>Upload Bukti Transfer</h3>
      <input type="file" id="proofFile" accept="image/*">

      <button onclick="uploadProof('${holdId}')"
        style="background:#22c55e">
        KIRIM BUKTI
      </button>

      <button onclick="closePayment()"
        style="background:#ef4444">
        TUTUP
      </button>

    </div>
  </div>
  `;

  document.body.insertAdjacentHTML("beforeend",html);
}

function closePayment(){
  document.getElementById("paymentModal")?.remove();
}
async function uploadProof(holdId){

  const fileInput = document.getElementById("proofFile");
  const file = fileInput.files[0];

  if(!file){
    alert("Pilih gambar bukti transfer dulu");
    return;
  }

  const reader = new FileReader();

  reader.onload = async function(){

    const base64 = reader.result;

    const fd = new URLSearchParams();
    fd.append("action","guest_upload_proof");
    fd.append("hold_id",holdId);
    fd.append("proof_url",base64);

    const res = await fetch(SERVER,{method:"POST",body:fd});
    const data = await res.json();

    if(data.status==="ok"){
      alert("Bukti berhasil dikirim. Tunggu admin konfirmasi.");
      closePayment();
    }else{
      alert(data.message);
    }
  };

  reader.readAsDataURL(file);
}
async function loadGuestProof(){

  const token = localStorage.getItem("gtoken");

  const fd = new URLSearchParams();
  fd.append("action","admin_guest_list");
  fd.append("token",token);

  const res = await fetch(SERVER,{method:"POST",body:fd});
  const data = await res.json();

  const list=document.getElementById("guestProofList");
  list.innerHTML="";

  if(!data.data || data.data.length===0){
    list.innerHTML="<p>Tidak ada pembayaran tamu</p>";
    return;
  }

  data.data.forEach(g=>{

    list.innerHTML += `
    <div style="
      background:#1e293b;
      padding:14px;
      border-radius:14px;
      margin-bottom:14px;
    ">

      <b>${g.name}</b><br>
      ${g.phone}<br>
      ${g.kelas} ${g.date} ${g.start}<br>
      Court ${g.court}<br><br>

      <div>
        Rp ${Number(g.amount).toLocaleString("id-ID")}
      </div><br>

      <img src="${g.proof}" style="
        width:100%;
        border-radius:12px;
        margin-bottom:12px;
      ">

      <button onclick="approveGuest('${g.hold_id}')"
        style="background:#22c55e;width:100%">
        APPROVE BOOKING
      </button>

    </div>
    `;
  });
}
async function approveGuest(holdId){

  if(!confirm("Konfirmasi booking tamu ini?")) return;

  const token = localStorage.getItem("gtoken");

  const fd = new URLSearchParams();
  fd.append("action","admin_guest_confirm");
  fd.append("token",token);
  fd.append("hold_id",holdId);

  const res = await fetch(SERVER,{method:"POST",body:fd});
  const data = await res.json();

  if(data.status==="ok"){
    alert("Booking berhasil dikonfirmasi!");
    loadGuestProof();
  }else{
    alert(data.message);
  }
}


</script>

</body>
</html>
