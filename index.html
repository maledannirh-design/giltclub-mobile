<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GILT Club Mobile</title>

<!-- ================= DESKTOP REDIRECT ================= -->
<script>
(function(){

  var host = location.hostname;

  // deteksi device
  var isMobile = /android|iphone|ipad|ipod|blackberry|windows phone/i
      .test(navigator.userAgent.toLowerCase());

  // kalau dibuka pakai laptop → balik ke utama
  if(host === "m.giltclub.my.id"){
      if(!isMobile){
          location.replace("https://giltclub.my.id");
          return;
      }
  }

})();
</script>
<!-- =================================================== -->

<style>
body{
  margin:0;
  font-family: Arial, Helvetica, sans-serif;
  background:#0f172a;
  color:white;
  display:flex;
  height:100vh;
  align-items:center;
  justify-content:center;
}

.card{
  width:90%;
  max-width:360px;
  display:none;
}


input{
  width:100%;
  padding:14px;
  margin-top:12px;
  border-radius:10px;
  border:none;
  font-size:16px;
}

button{
  width:100%;
  padding:14px;
  margin-top:18px;
  border-radius:12px;
  border:none;
  background:#22c55e;
  color:white;
  font-size:18px;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
  <h2>G-WALLET</h2>
  <input id="username" placeholder="Username">
  <input id="pin" type="password" placeholder="PIN">
  <button onclick="login()">LOGIN</button>
</div>
<div id="dashboard" style="display:none; padding:20px;">

  <h2 id="welcome"></h2>
  <p>Member ID: <span id="memberid"></span></p>
  <p>Role: <span id="role"></span></p>

  <button onclick="logout()" style="background:#ef4444;">
    LOGOUT
  </button>

</div>

<script>

const SERVER = "https://script.google.com/macros/s/AKfycbw_D4TTo21Atgoi1ttpFahfogmLq7jefNl8fnqkn29LLdT6AnZgFKWIMWELYzbVZcnZ/exec";

async function login(){

  const username = document.getElementById("username").value;
  const pin = document.getElementById("pin").value;

  const formData = new URLSearchParams();
  formData.append("action","login");
  formData.append("username",username);
  formData.append("pin",pin);
  formData.append("device",navigator.userAgent);

  try{

    const res = await fetch(SERVER,{
      method:"POST",
      body:formData
    });

    const text = await res.text();
    const data = JSON.parse(text);

    if(data.status==="ok"){
        localStorage.setItem("guser",JSON.stringify(data.user));
        localStorage.setItem("gtoken",data.token);
        showDashboard(data.user);
    }else{
        alert(data.message);
    }

  }catch(err){
    alert("Tidak bisa konek ke server");
    console.log(err);
  }
}

// ===== AUTO LOGIN CHECK =====
document.addEventListener("DOMContentLoaded", checkSession);

async function checkSession(){

  const card = document.querySelector(".card");
  const token = localStorage.getItem("gtoken");

  // default: sembunyikan login dulu
  card.style.display = "none";

  // kalau tidak ada token → langsung tampilkan login
  if(!token){
    card.style.display = "block";
    return;
  }

  try{

    const formData = new URLSearchParams();
    formData.append("action","session");
    formData.append("token",token);

    const res = await fetch(SERVER,{
      method:"POST",
      body:formData
    });

    const data = await res.json();

    if(data.status==="ok"){
        // session valid → langsung dashboard
        showDashboard(data.user);
        return;
    }

    // token invalid
    localStorage.removeItem("gtoken");
    localStorage.removeItem("guser");
    card.style.display = "block";

  }catch(err){
    // server unreachable → tetap kasih login
    console.log("session restore fail");
    card.style.display = "block";
  }
}

  
function showDashboard(user){

  document.querySelector(".card").style.display = "none";
  document.getElementById("dashboard").style.display = "block";

  document.getElementById("welcome").innerText =
    "Welcome " + user.name;

  document.getElementById("memberid").innerText =
    user.member_id;

  document.getElementById("role").innerText =
    user.role;
}

function logout(){
  localStorage.removeItem("gtoken");
  localStorage.removeItem("guser");
  location.reload();
}
</script>

</body>
</html>
